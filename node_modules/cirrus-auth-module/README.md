# Cirrus Authentication Module

#### Contents
- [What is this module?](#what-is-this-module)
- [Quick Start](#quick-start)
- [Running your application](#running-your-application)
  - [Heroku](#heroku)
- [In-depth guide](#in-depth-guide)
  - [Installation](#installation)
  - [Usage](#usage)
 
 ##### Contributors:
 
 - Ben Ewen

### What is this module?
>This module is designed to provide an _out of the box_ authentication solution for a NodeJS application running on Heroku. The code is provided as a module to enhance maintainability and also to allow developers to integrate Cirrus's authentication into their applications.

#### This module is also included as standard in our [Web Accelerator](https://github.com/EliLillyCo/CIRR_WEB_ACCELERATOR). This is the quickest way to develop an application with authentication.
##### If you prefer, you can also import it into any application running [express](https://expressjs.com/) by following the quick start guide below.

### Quick start

##### What do I need?
 - [ ]  A [NodeJS](https://nodejs.org/en/) application running [express](https://expressjs.com/) _(**Step 5** below provides a basic express server)_
 - [ ]  Depending on your chosen flow(s), you may need additional credentails. Production flows require extra credentails  from the identity team.


**1.** Decide which flow(s) to use from the following:
 - [Pre-production flow](https://github.com/EliLillyCo/CIRR_PING_AUTH_MODULE)
 - [~~Production flow~~(Deprecated, please use Open ID)](https://github.com/EliLillyCo/CIRR_SF_AUTH_MODULE)
 - [Production flow (Open ID)](https://github.com/EliLillyCo/CIRR_OIDC_AUTH_MODULE)
 
**1.1.** Set up the flow(s) by following the instructions in the above repositories.

**2.** Create a folder to store your project.

**2.1.** Create a file called `.npmrc` in your folder, open it in a text editor and add the following lines:

_This code allows your application to access Lilly's private package repository_
```
registry=https://npm-proxy.fury.io/C4a7337WDFSKV4waL6CL/h_app58363299/
ca=
```
**3.** Open a terminal and change to your project's directory.

**3.1.** Install the `cirrus-auth-module` by running `npm install cirrus-auth-module --save`

**4.** Create a file called `app.js`

**4.1** Require the authentication module by adding these lines to `app.js`: 
``` javascript 
const auth = require('cirrus-auth-module');
```

**5.** Call the `authenticate()` method on your router or express app like so:

_This code creates a basic express server, you can copy and paste it for a working example_
``` javascript
const express = require('express');
const auth = require('cirrus-auth-module');
const app = express();

// Our port the application will listen on.
const PORT = process.env.PORT || 8080;

// call cirrus-auth-modue authenticate method on our express app
auth.authenticate(app);

app.get('/', (req, res) => {
  res.send('test');
});

app.listen(PORT, () => {
  console.log(`Server running at localhost:${PORT}`);
});
```

### Running your application

#### Heroku
1. Push your code to a Github repository
2. Create a new Heroku app
3. Connect your Github repo to your Heroku application
4. Set your environment variables up for your flow(s) under the settings tab -> config vars
5. Deploy your application

### In-depth guide

This module is a hybrid authentication module. Therefore, it can be configured in different ways depending on your authentication requirements. Supported flow modules are listed at the top of this readme.

Follow the steps in the relevant readme (_it is not necessary to install the above modules, this module will do that for you_).

Notice that in each flow readme, there is an environment variable called `AUTH_TYPE` this tells this module which flow to initialise - so it's important to not leave this out!

It's also worth noting that you can follow _mutliple_ flow setup instructions to have access to multiple flows inside your application. Switching between them is as simple as changing the `AUTH_TYPE` variable from one flow to the other. This is useful when you want authentication on pre-production **and** production applications.

### Installation

The auth module is located on Lilly's Gemfury private repository. To gain access to this module, you first need access to the Gemfury repository. To do this, create a file called `.npmrc` in the **root** of your app directory.

Add the following lines to `.npmrc`

```
registry=https://npm-proxy.fury.io/C4a7337WDFSKV4waL6CL/h_app58363299/
ca=
```
Afterwards, you can install any module stored on Lilly's Gemfury account as you would any other.

**To install the auth module, run:** `npm install cirrus-auth-module --save`

### Usage

Install this module and require it into your applications express file like so:

``` javascript 
const auth = require('cirrus-auth-module');
```

Then call the authenticate function, passing in your router like so:

``` javascript 
auth.authenticate(router);
```

**Remember to have the `AUTH_TYPE` variable set to one of the supported flows as described in their respective readme (see quick start for flows).**

This module will print out information in your console about the auth process, which is useful for debugging.
These can be disabled with the `DISABLE_AUTH_LOGS` environment variable.

---
